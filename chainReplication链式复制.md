---
title: Chain Replication 链式复制
date: 2023-11-12 15:28:29
tags:
---
链式复制
<!--more-->
# 查询状态与系统事务
系统定义了两种状态，分别是
* pending：被接收，但未被执行
* hist：被执行的

关于这些状态的转变，有以下三种事务
* T1：收到请求，将请求放入pending队列
* T2：请求被忽略，将请求移出pending队列（很少发生）
* T3：请求被执行，将请求移出pending队列，若该请求为update，放入hist队列
# 链式复制协议
节点以链表形式相连，有head节点和tail节点。t个节点的系统中最多允许t-1个节点崩溃。
系统中的三种事务如下：
* 回复：所有请求都由tail节点回复
* 查询处理：所有的查询请求都转发至tail节点处理，访问tail节点的数据
* 更新处理：所有的更新请求都转发至head节点处理，并由head节点从前往后传递到tail节点

可以看到，查询处理只由一个节点处理，而更新处理需要t-1个节点处理，因此更新处理比查询处理更耗时。同时，为了减少更新的成本，将所有的计算操作放在head节点，其他节点只执行write操作。操作的不确定性也全部来源于head。
## 容错
为了提供容错机制，系统引入master，认为master是单一且可靠的（实际上用Paxos算法提供可靠性）。master责任如下：
* 检测节点是否宕机
* 通知宕机节点的前后节点
* 向客户端提供chain的头尾节点

由于hist是从后向前传播的，链中前面节点的hist的后面节点hist的子集
### head节点宕机
处理方式：使用head的下一个节点作为head。
结果分析：这个过程修改了pending，下一个节点的pending是head的子集，差集部分相当于被忽略。所以head节点宕机**相当于事务T2**。
### tail节点宕机
处理方式：使用tail的前一个节点T-作为tail
结果分析：同时修改了hist和pending，T-的hist是tail的子集，而tail的pending是T-的子集，所以tail节点宕机相当于事务T3。
### 中间节点宕机
处理方式：通知宕机节点S的前后节点S- S+，并让前节点S-保证update操作的传递