---
title: CMU15-445-Lec10  Sorting & Aggregation Algorithms
date: 2024-02-21 22:04:11
tags:
    - DB
---
排序和聚合算子
<!-- more -->
# 排序
排序在DBMS中经常用到，如
1. 显式：order by
2. 隐式：distinct、group by、join

DBMS需要考虑查询结果超出buffer范围的情况，即结果需要溢出到磁盘，需要使用外排序等技术。

假如order by中使用了limit关键字，可以使用top-N heap算法，最佳情况下只需要顺序扫一遍磁盘（即N小于buffer）

一般情况下，需要使用外排序算法，分为两个阶段
1. 外排序阶段：将数据分成多个小文件，每个小文件包含一个有序序列
2. 合并阶段：将多个有序小文件合并成一个有序的大文件

基础算法在合并阶段只读两个page，将其合并到一个page上并写出。
当buffer足够大时，可以有以下优化思路：
1. 读入多个page，做多路归并
2. 预取下一个run的page，减少io时间

如果可以用到B+树的聚簇索引的话，可以大大减少IO时间和计算时间。但是如果B+树不是聚簇索引，不建议使用B+树减少排序时间，因为IO开销可能会很大
# 聚合
聚合是将分组后的数据向量聚合成标量。聚合算法有两种实现方法：
1. 排序：在group by的属性上排序，DBMS再顺序扫描做聚合计算（可以将filter算子下推优化排序）
2. 哈希：扫描数据过程中填hash表，逐步修改结果

哈希的两个阶段：
1. partition：分区，根据hash key（如group by的key）将数据分成多个区
2. rehash：将各个分区读入buffer中并计算更新结果
